/*
 * Instituto de Matematica Pura e Aplicada - IMPA
 * Departamento de Dinamica dos Fluidos
 *
 */
package rpn.command;

import java.awt.event.ActionEvent;
import rpn.controller.phasespace.NUMCONFIG;
import rpn.parser.RPnDataModule;
import rpnumerics.RPNUMERICS;
import rpnumerics.PhasePoint;
import rpnumerics.HugoniotCurve;
import wave.util.RealVector;
import java.beans.PropertyChangeEvent;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import rpn.component.HugoniotCurveGeom;
import rpn.component.ManifoldGeom;
import rpn.component.RpGeometry;
import rpn.component.StationaryPointGeom;
import rpn.component.StationaryPointGeomFactory;
import rpn.component.XZeroGeom;
import rpn.component.XZeroGeomFactory;
import rpn.configuration.CommandConfiguration;
import rpn.configuration.Configuration;
import rpn.controller.phasespace.InvariantsReadyImpl;
import rpn.controller.phasespace.NumConfigReadyImpl;
import rpn.controller.phasespace.ProfileSetupReadyImpl;
import rpn.controller.ui.*;
import rpnumerics.StationaryPoint;
import rpnumerics.StationaryPointCalc;

public class ChangeSigmaCommand extends RpModelConfigChangeCommand {
    //
    // Constants
    //

    static public final String DESC_TEXT = "Change Hugoniot Speed";
    //
    // Members
    //
    private static ChangeSigmaCommand instance_ = null;


    //
    // Constructors
    //
    protected ChangeSigmaCommand() {
        super(DESC_TEXT);

    }


    public void execute() {

        System.out.println("Execute de ChangeSigmaAgent");

        Double oldValue = new Double(RPNUMERICS.getViscousProfileData().getSigma());
        RealVector[] userInputList = UIController.instance().userInputList();
        RealVector lastPointAdded = userInputList[userInputList.length - 1];
        double newSigma;

        HugoniotCurveGeom hGeom = ((NUMCONFIG) RPnDataModule.PHASESPACE.state()).hugoniotGeom();
        HugoniotCurve hCurve = (HugoniotCurve) hGeom.geomFactory().geomSource();

        //newSigma = hCurve.findSigma(new PhasePoint(lastPointAdded));
        newSigma = hCurve.velocity(lastPointAdded);
        RPNUMERICS.getViscousProfileData().setSigma(newSigma);

        Double newValue = new Double(RPNUMERICS.getViscousProfileData().getSigma());

        RealVector closestPoint = hCurve.findClosestPoint(lastPointAdded);
        RPNUMERICS.getViscousProfileData().setUplus(new PhasePoint(closestPoint));

        //--------------------- Remove os pontos estacionarios
        Iterator it = RPnDataModule.PHASESPACE.getGeomObjIterator();
        List<RpGeometry> list = new ArrayList<RpGeometry>();

        while (it.hasNext()) {
            RpGeometry geometry = (RpGeometry) it.next();

            if (((geometry instanceof StationaryPointGeom)) && !(geometry instanceof XZeroGeom)) {
                list.add(geometry);

            }

        }

        for (RpGeometry rpgeometry : list) {
            RPnDataModule.PHASESPACE.remove(rpgeometry);
        }

        //--- Atualiza o ponto estacionario associado ao XZero
        XZeroGeomFactory xzeroRef = new XZeroGeomFactory(new StationaryPointCalc(hCurve.getXZero(), hCurve.getXZero()));

        //--- Produz lista de pontos de equilibrio
        List<RealVector> eqPoints = hCurve.equilPoints(closestPoint);

        //--- o join daqui Ã© para as setas dos pontos estacionarios
        for (RealVector realVector : eqPoints) {
            StationaryPointGeomFactory xzeroFactory = new StationaryPointGeomFactory(new StationaryPointCalc(new PhasePoint(realVector), hCurve.getXZero()));

            RPnDataModule.PHASESPACE.join(xzeroFactory.geom());

        }

        System.out.println("RPnDataModule.PHASESPACE.state() :::::::::::::::::: " + RPnDataModule.PHASESPACE.state());


        if (RPnDataModule.PHASESPACE.state() instanceof ProfileSetupReadyImpl) {

            Iterator iter = RPnDataModule.PHASESPACE.getGeomObjIterator();
            List<RpGeometry> listManifolds = new ArrayList<RpGeometry>();

            while (iter.hasNext()) {
                RpGeometry geometry = (RpGeometry) iter.next();

                if (geometry instanceof ManifoldGeom) {
                    listManifolds.add(geometry);
                }

            }

            for (RpGeometry rpgeometry : listManifolds) {
                RPnDataModule.PHASESPACE.remove(rpgeometry);
            }

            // ------------------

            System.out.println("ENtramos no ProfileSetup...............");

            RPnDataModule.PHASESPACE.state().plot(RPnDataModule.PHASESPACE, xzeroRef.geom());

            StationaryPointCalc statCalc = new StationaryPointCalc(new PhasePoint(closestPoint), hCurve.getXZero());
            StationaryPointGeomFactory statFactory = new StationaryPointGeomFactory(statCalc);
            StationaryPointGeom statGeom = (StationaryPointGeom) statFactory.geom();
            RPnDataModule.PHASESPACE.state().plot(RPnDataModule.PHASESPACE, statGeom);




        } else {
            boolean manifold = ((NumConfigReadyImpl) RPnDataModule.PHASESPACE.state()).isPlotManifold();
            NumConfigReadyImpl state = new NumConfigReadyImpl(hGeom, (XZeroGeom) xzeroRef.geom(), manifold);

            RPnDataModule.PHASESPACE.changeState(state);


            if (state.isPlotManifold()) {   //*** os plots daqui sao para manifolds
                RPnDataModule.PHASESPACE.changeState(new InvariantsReadyImpl(hGeom, (XZeroGeom) xzeroRef.geom()));

                for (RealVector realVector : eqPoints) {
                    StationaryPointGeomFactory xzeroFactory = new StationaryPointGeomFactory(new StationaryPointCalc(new PhasePoint(realVector), hCurve.getXZero()));

                    StationaryPoint testePoint = (StationaryPoint) xzeroFactory.geomSource();

                    System.out.println(testePoint.getElement(0) + " " + testePoint.getElement(1) + " Sela: " + testePoint.isSaddle());


                    RPnDataModule.PHASESPACE.plot(xzeroFactory.geom());

                }
                RPnDataModule.PHASESPACE.plot((XZeroGeom) xzeroRef.geom());

            }

        }

        applyChange(new PropertyChangeEvent(this, DESC_TEXT, oldValue, newValue));

    }
    
    
    
    @Override
     public void applyChange(PropertyChangeEvent event ){
        
        Double newParameters = (Double) event.getNewValue();
    
        Configuration newConfiguration = new CommandConfiguration(toString());
        
        newConfiguration.setParamValue("sigma", newParameters.toString());

        PropertyChangeEvent commandEvent = new PropertyChangeEvent(this, null, null,newConfiguration);
                
        logCommand(new RpCommand(commandEvent));
        
        super.applyChange(event);
        
    }
    
    

    public void unexecute() {
        Double oldValue = (Double) log().getNewValue();
        System.out.println("OLD SIGMA = " + oldValue);
        Double newValue = (Double) log().getOldValue();
        RPNUMERICS.getViscousProfileData().setSigma(newValue);
        System.out.println("NEW SIGMA = " + newValue);
        applyChange(new PropertyChangeEvent(this, DESC_TEXT, oldValue, newValue));
    }


    


    static public ChangeSigmaCommand instance() {
        if (instance_ == null) {
            instance_ = new ChangeSigmaCommand();
        }
        return instance_;
    }
}
